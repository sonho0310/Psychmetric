<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychrometric</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; color: #1c1917; }
        .chart-container {
            position: relative;
            width: 100%;
            height: 450px;
            max-height: 500px;
        }
        .active-tab { 
            border-bottom: 2px solid #ea580c; 
            color: #ea580c; 
            font-weight: 700; 
            background-color: #fff7ed;
        }
        .inactive-tab { 
            color: #78716c; 
            font-weight: 500;
        }
        .inactive-tab:hover {
            color: #ea580c;
            background-color: #fafaf9;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
           -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #ea580c; cursor: pointer; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #d6d3d1; border-radius: 2px; }
        
        .input-group-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #a8a29e; margin-bottom: 0.25rem; }
    </style>
    <!-- 
        UPDATE LOG:
        - Added 'calculateFromInputs' logic handling 3-way dependency (DB, WB, RH).
        - Properties Tab: Added WB Input field.
        - Process/Mixing Tabs: Added RH Input fields.
        - Logic: 
            - Change DB -> Keep RH, Calc WB.
            - Change RH -> Keep DB, Calc WB.
            - Change WB -> Keep DB, Calc RH.
    -->
</head>
<body class="bg-stone-50 text-stone-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-sm">P</div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold tracking-tight text-stone-900 leading-tight">Psychrometry Explorer</h1>
                    <p class="text-[10px] md:text-xs text-stone-500 font-medium">Trane Clinic | H·ªá SI</p>
                </div>
            </div>
            <nav class="hidden md:flex space-x-1 bg-stone-100 p-1 rounded-lg">
                <button onclick="switchTab('properties')" id="nav-properties" class="active-tab px-4 py-2 text-sm rounded-md transition-all">Th√¥ng s·ªë</button>
                <button onclick="switchTab('processes')" id="nav-processes" class="inactive-tab px-4 py-2 text-sm rounded-md transition-all">Qu√° tr√¨nh</button>
                <button onclick="switchTab('mixing')" id="nav-mixing" class="inactive-tab px-4 py-2 text-sm rounded-md transition-all">H√≤a tr·ªôn</button>
            </nav>
        </div>
    </header>

    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 py-3 flex justify-around z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('properties')" id="mob-nav-properties" class="flex flex-col items-center text-orange-600">
            <span class="text-xl">üå°Ô∏è</span>
            <span class="text-[10px] font-bold mt-1">Th√¥ng s·ªë</span>
        </button>
        <button onclick="switchTab('processes')" id="mob-nav-processes" class="flex flex-col items-center text-stone-400">
            <span class="text-xl">‚öôÔ∏è</span>
            <span class="text-[10px] font-medium mt-1">Qu√° tr√¨nh</span>
        </button>
        <button onclick="switchTab('mixing')" id="mob-nav-mixing" class="flex flex-col items-center text-stone-400">
            <span class="text-xl">üå™Ô∏è</span>
            <span class="text-[10px] font-medium mt-1">H√≤a tr·ªôn</span>
        </button>
    </div>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 pb-24 md:pb-8">

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
            
            <!-- LEFT COLUMN: CHART -->
            <div class="lg:col-span-7 space-y-4">
                <div class="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                    <div class="px-4 py-3 bg-stone-50 border-b border-stone-200 flex justify-between items-center">
                        <h3 class="font-bold text-stone-800 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            Bi·ªÉu ƒë·ªì Kh√¥ng kh√≠ ·∫©m
                        </h3>
                        <span class="text-[10px] bg-white border border-stone-200 text-stone-500 px-2 py-1 rounded shadow-sm font-mono">101.325 kPa</span>
                    </div>
                    <div class="p-2 md:p-4">
                        <div class="chart-container">
                            <canvas id="psychChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Helper Text -->
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 text-sm text-amber-900 rounded-r shadow-sm flex items-start gap-2">
                    <span class="text-lg">üí°</span>
                    <div>
                        <strong>C∆° ch·∫ø nh·∫≠p li·ªáu th√¥ng minh:</strong> Ch·ªâ c·∫ßn nh·∫≠p <strong>2 trong 3</strong> th√¥ng s·ªë (DB, WB, RH), th√¥ng s·ªë th·ª© 3 s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c t√≠nh to√°n.
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: CONTROLS -->
            <div class="lg:col-span-5">
                
                <!-- TAB 1: PROPERTIES (Th√¥ng s·ªë) -->
                <div id="tab-properties" class="animate-fade-in block">
                    <div class="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-stone-100 bg-gradient-to-r from-white to-stone-50">
                            <h3 class="text-lg font-bold text-stone-900">ƒêi·ªÉm Tr·∫°ng Th√°i</h3>
                            <p class="text-xs text-stone-500">Nh·∫≠p 2 th√¥ng s·ªë b·∫•t k·ª≥ ƒë·ªÉ tra c·ª©u.</p>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            <!-- Inputs Row -->
                            <div class="grid grid-cols-3 gap-4">
                                <!-- DB Input -->
                                <div>
                                    <label class="input-group-label block">B·∫ßu Kh√¥ (DB)</label>
                                    <div class="relative">
                                        <input type="number" id="prop-db" value="25" min="0" max="50" step="0.1" 
                                               class="w-full text-center font-bold text-lg text-orange-600 border border-stone-300 rounded-md py-2 focus:ring-2 focus:ring-orange-500 focus:outline-none"
                                               oninput="handlePropInput('db')">
                                        <span class="absolute top-0 right-1 text-[10px] text-stone-400 leading-none mt-1">¬∞C</span>
                                    </div>
                                </div>
                                <!-- WB Input -->
                                <div>
                                    <label class="input-group-label block">B·∫ßu ∆Ø·ªõt (WB)</label>
                                    <div class="relative">
                                        <input type="number" id="prop-wb" value="18" min="-5" max="50" step="0.1" 
                                               class="w-full text-center font-bold text-lg text-blue-600 border border-stone-300 rounded-md py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                               oninput="handlePropInput('wb')">
                                        <span class="absolute top-0 right-1 text-[10px] text-stone-400 leading-none mt-1">¬∞C</span>
                                    </div>
                                </div>
                                <!-- RH Input -->
                                <div>
                                    <label class="input-group-label block">ƒê·ªô ·∫®m (RH)</label>
                                    <div class="relative">
                                        <input type="number" id="prop-rh" value="50" min="0" max="100" step="1" 
                                               class="w-full text-center font-bold text-lg text-green-600 border border-stone-300 rounded-md py-2 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                               oninput="handlePropInput('rh')">
                                        <span class="absolute top-0 right-1 text-[10px] text-stone-400 leading-none mt-1">%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sliders (Linked to Inputs) -->
                            <div class="space-y-4 pt-4 border-t border-stone-100">
                                <div>
                                    <div class="flex justify-between text-xs text-stone-500 mb-1">
                                        <span>ƒêi·ªÅu ch·ªânh DB</span>
                                        <span id="label-range-db" class="font-mono">25¬∞C</span>
                                    </div>
                                    <input type="range" id="range-prop-db" min="0" max="50" step="0.5" value="25" oninput="handlePropSlider('db')">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-stone-500 mb-1">
                                        <span>ƒêi·ªÅu ch·ªânh RH</span>
                                        <span id="label-range-rh" class="font-mono">50%</span>
                                    </div>
                                    <input type="range" id="range-prop-rh" min="1" max="100" step="1" value="50" oninput="handlePropSlider('rh')">
                                </div>
                            </div>

                            <!-- Detailed Results -->
                            <div class="grid grid-cols-2 gap-3 bg-stone-50 p-4 rounded-lg border border-stone-100">
                                <div>
                                    <div class="text-[10px] text-stone-500">ƒê·ªô ch·ª©a h∆°i (d)</div>
                                    <div class="font-mono text-base font-bold text-stone-800" id="calc-w">--</div>
                                    <div class="text-[10px] text-stone-400">g/kg</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-stone-500">Enthalpy (h)</div>
                                    <div class="font-mono text-base font-bold text-stone-800" id="calc-h">--</div>
                                    <div class="text-[10px] text-stone-400">kJ/kg</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-stone-500">Th·ªÉ t√≠ch ri√™ng (v)</div>
                                    <div class="font-mono text-base font-bold text-stone-800" id="calc-v">--</div>
                                    <div class="text-[10px] text-stone-400">m¬≥/kg</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-stone-500">ƒêi·ªÉm s∆∞∆°ng (DP)</div>
                                    <div class="font-mono text-base font-bold text-stone-800" id="calc-dp">--</div>
                                    <div class="text-[10px] text-stone-400">¬∞C</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: PROCESSES -->
                <div id="tab-processes" class="hidden animate-fade-in">
                    <div class="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-stone-100 bg-gradient-to-r from-white to-stone-50">
                            <h3 class="text-lg font-bold text-stone-900">T√≠nh T·∫£i Nhi·ªát</h3>
                            <p class="text-xs text-stone-500">Nh·∫≠p 2 s·ªë li·ªáu cho m·ªói ƒëi·ªÉm tr·∫°ng th√°i.</p>
                        </div>

                        <div class="p-4 space-y-4">
                            <!-- Point 1 -->
                            <div class="p-3 bg-orange-50 border border-orange-100 rounded-lg">
                                <h4 class="text-xs font-bold text-orange-700 uppercase mb-2 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-orange-500"></span> ƒêi·ªÉm V√†o (1)
                                </h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label class="input-group-label">DB (¬∞C)</label><input type="number" id="p1-db" value="27" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p1', 'db')"></div>
                                    <div><label class="input-group-label">WB (¬∞C)</label><input type="number" id="p1-wb" value="19.5" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p1', 'wb')"></div>
                                    <div><label class="input-group-label">RH (%)</label><input type="number" id="p1-rh" value="50" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p1', 'rh')"></div>
                                </div>
                            </div>

                            <!-- Point 2 -->
                            <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                <h4 class="text-xs font-bold text-blue-700 uppercase mb-2 flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-blue-500"></span> ƒêi·ªÉm Ra (2)
                                </h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label class="input-group-label">DB (¬∞C)</label><input type="number" id="p2-db" value="13" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p2', 'db')"></div>
                                    <div><label class="input-group-label">WB (¬∞C)</label><input type="number" id="p2-wb" value="12" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p2', 'wb')"></div>
                                    <div><label class="input-group-label">RH (%)</label><input type="number" id="p2-rh" value="90" class="w-full text-sm border p-1 rounded font-bold" oninput="handleProcessInput('p2', 'rh')"></div>
                                </div>
                            </div>

                            <!-- Flow -->
                            <div class="flex items-center justify-between bg-white p-3 border border-stone-200 rounded-lg">
                                <label class="text-xs font-bold text-stone-600 uppercase">L∆∞u l∆∞·ª£ng</label>
                                <div class="flex items-center gap-1">
                                    <input type="number" id="process-flow" value="1000" step="50" class="w-24 text-right font-bold text-stone-800 border-b border-stone-300 focus:outline-none" oninput="calcProcess()">
                                    <span class="text-xs text-stone-400">l/s</span>
                                </div>
                            </div>

                            <!-- Results -->
                            <div class="bg-stone-900 text-white rounded-lg p-4 shadow-inner">
                                <div class="flex justify-between items-center mb-3 pb-2 border-b border-stone-700">
                                    <span class="text-xs font-medium text-stone-300">T·ªïng C√¥ng Su·∫•t</span>
                                    <span class="text-xl font-bold text-yellow-400" id="res-qt">-- kW</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center text-[10px] text-stone-400">
                                    <div>
                                        <div>Nhi·ªát Hi·ªán</div>
                                        <div class="text-sm font-mono text-white mt-1" id="res-qs">--</div>
                                    </div>
                                    <div class="border-l border-stone-700">
                                        <div>Nhi·ªát ·∫®n</div>
                                        <div class="text-sm font-mono text-white mt-1" id="res-ql">--</div>
                                    </div>
                                    <div class="border-l border-stone-700">
                                        <div>SHR</div>
                                        <div class="text-sm font-mono text-white mt-1" id="res-shr">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: MIXING -->
                <div id="tab-mixing" class="hidden animate-fade-in">
                    <div class="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-stone-100 bg-gradient-to-r from-white to-stone-50">
                            <h3 class="text-lg font-bold text-stone-900">T√≠nh H√≤a Tr·ªôn</h3>
                            <p class="text-xs text-stone-500">Nh·∫≠p 2 s·ªë li·ªáu cho m·ªói d√≤ng kh√≠.</p>
                        </div>
                        
                        <div class="p-4 space-y-4">
                            <!-- Stream 1 -->
                            <div class="p-3 border-l-4 border-orange-200 bg-stone-50 rounded-r">
                                <div class="flex justify-between mb-2">
                                    <h4 class="text-xs font-bold text-stone-500 uppercase">D√≤ng 1 (Kh√≠ H·ªìi)</h4>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="m1-flow" value="4000" class="w-16 text-right text-xs font-bold bg-transparent border-b border-stone-300" oninput="calcMixing()">
                                        <span class="text-[10px]">l/s</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label class="input-group-label">DB</label><input type="number" id="m1-db" value="25" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m1', 'db')"></div>
                                    <div><label class="input-group-label">WB</label><input type="number" id="m1-wb" value="18" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m1', 'wb')"></div>
                                    <div><label class="input-group-label">RH</label><input type="number" id="m1-rh" value="50" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m1', 'rh')"></div>
                                </div>
                            </div>

                            <!-- Stream 2 -->
                            <div class="p-3 border-l-4 border-blue-200 bg-stone-50 rounded-r">
                                <div class="flex justify-between mb-2">
                                    <h4 class="text-xs font-bold text-stone-500 uppercase">D√≤ng 2 (Kh√≠ T∆∞∆°i)</h4>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="m2-flow" value="1000" class="w-16 text-right text-xs font-bold bg-transparent border-b border-stone-300" oninput="calcMixing()">
                                        <span class="text-[10px]">l/s</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label class="input-group-label">DB</label><input type="number" id="m2-db" value="35" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m2', 'db')"></div>
                                    <div><label class="input-group-label">WB</label><input type="number" id="m2-wb" value="28" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m2', 'wb')"></div>
                                    <div><label class="input-group-label">RH</label><input type="number" id="m2-rh" value="60" class="w-full text-sm border p-1 rounded bg-white" oninput="handleMixingInput('m2', 'rh')"></div>
                                </div>
                            </div>

                            <!-- Result Mix -->
                            <div class="mt-4 p-4 bg-gradient-to-br from-stone-100 to-stone-200 rounded-lg border border-stone-300 text-center">
                                <span class="text-[10px] uppercase font-bold text-stone-500 tracking-widest">ƒêi·ªÉm H·ªón H·ª£p (Mixed)</span>
                                <div class="flex justify-center items-center gap-4 mt-2">
                                    <div>
                                        <div class="text-2xl font-bold text-stone-800" id="mix-db">--</div>
                                        <div class="text-[10px] text-stone-500">DB (¬∞C)</div>
                                    </div>
                                    <div class="h-8 w-px bg-stone-300"></div>
                                    <div>
                                        <div class="text-xl font-bold text-stone-600 font-mono" id="mix-wb">--</div>
                                        <div class="text-[10px] text-stone-500">WB (¬∞C)</div>
                                    </div>
                                    <div class="h-8 w-px bg-stone-300"></div>
                                    <div>
                                        <div class="text-xl font-bold text-stone-600 font-mono" id="mix-h">--</div>
                                        <div class="text-[10px] text-stone-500">h (kJ/kg)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- MATH UTILS (SI) ---
        const P_ATM = 101.325; // kPa

        function getPsat(t) {
            return 0.61078 * Math.exp((17.27 * t) / (t + 237.3));
        }

        function getPv(t, rh) {
            return getPsat(t) * (rh / 100);
        }

        function getW(t, rh) {
            let pv = getPv(t, rh);
            if (pv >= P_ATM) pv = P_ATM - 0.01;
            const w = 0.622 * pv / (P_ATM - pv);
            return w * 1000; // g/kg
        }

        function getEnthalpy(t, wGrams) {
            const w = wGrams / 1000;
            return 1.006 * t + w * (2501 + 1.86 * t);
        }

        function getVol(t, wGrams) {
            const w = wGrams / 1000;
            return (0.287042 * (t + 273.15) * (1 + 1.6078 * w)) / P_ATM;
        }

        function getDewPoint(t, rh) {
            if (rh <= 0) return -50;
            const gamma = Math.log(rh / 100) + (17.27 * t) / (237.3 + t);
            return (237.3 * gamma) / (17.27 - gamma);
        }

        // Calculate WB from DB and RH (Iterative)
        function calcWB(db, rh) {
            let low = -20, high = db;
            const targetPv = getPv(db, rh);
            for(let i=0; i<20; i++) {
                let mid = (low + high) / 2;
                let psMid = getPsat(mid);
                // Ferrel's equation approx or similar carrier eq
                let pvCalc = psMid - 0.000666 * P_ATM * (db - mid);
                if (pvCalc > targetPv) high = mid;
                else low = mid;
            }
            return (low + high) / 2;
        }

        // Calculate RH from DB and WB
        function calcRH(db, wb) {
            const psWb = getPsat(wb);
            const pv = psWb - 0.000666 * P_ATM * (db - wb);
            const psDb = getPsat(db);
            let rh = (pv / psDb) * 100;
            if (rh > 100) rh = 100;
            if (rh < 0) rh = 0;
            return rh;
        }

        // --- CORE LOGIC ---
        
        // Universal Input Handler for 3-way dependency
        // Returns the updated set {db, wb, rh}
        function resolveState(db, wb, rh, trigger) {
            let nDB = parseFloat(db);
            let nWB = parseFloat(wb);
            let nRH = parseFloat(rh);

            if (trigger === 'db') {
                // Keep RH constant, Update WB
                nWB = calcWB(nDB, nRH);
            } else if (trigger === 'rh') {
                // Keep DB constant, Update WB
                nWB = calcWB(nDB, nRH);
            } else if (trigger === 'wb') {
                // Keep DB constant, Update RH
                nRH = calcRH(nDB, nWB);
            }
            
            return { db: nDB, wb: nWB, rh: nRH };
        }

        // --- UI HANDLERS ---

        let chartInstance = null;
        let currentTab = 'properties';

        function initChart() {
            const ctx = document.getElementById('psychChart').getContext('2d');
            const satCurve = [];
            for(let t=-5; t<=55; t++) satCurve.push({x: t, y: getW(t, 100)});
            
            const rh50 = [];
            for(let t=-5; t<=55; t+=2) rh50.push({x: t, y: getW(t, 50)});

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'B√£o H√≤a', data: satCurve, showLine:true, borderColor: '#2563eb', borderWidth: 2, pointRadius:0, tension:0.4 },
                        { label: '50% RH', data: rh50, showLine:true, borderColor: '#bfdbfe', borderWidth:1, borderDash:[5,5], pointRadius:0, tension:0.4 },
                        { label: 'ƒêi·ªÉm', data: [{x:25, y:getW(25,50)}], backgroundColor:'#ea580c', pointRadius:8 },
                        { label: 'Line', data: [], showLine:true, borderColor:'#dc2626', borderWidth:2, pointRadius:4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type:'linear', position:'bottom', min:-5, max:55, title:{display:true, text:'Nhi·ªát ƒë·ªô B·∫ßu kh√¥ (¬∞C)'} },
                        y: { type:'linear', position:'right', min:0, max:35, title:{display:true, text:'ƒê·ªô ch·ª©a h∆°i (g/kg)'} }
                    },
                    plugins: { legend: {display:false}, tooltip: {callbacks: {label: c => `DB:${c.parsed.x.toFixed(1)}, W:${c.parsed.y.toFixed(1)}`}} }
                }
            });
        }

        // --- PROP TAB ---
        function handlePropInput(trigger) {
            let db = document.getElementById('prop-db').value;
            let wb = document.getElementById('prop-wb').value;
            let rh = document.getElementById('prop-rh').value;

            const res = resolveState(db, wb, rh, trigger);
            
            // Update Inputs
            if(trigger !== 'db') document.getElementById('prop-db').value = res.db.toFixed(1);
            if(trigger !== 'wb') document.getElementById('prop-wb').value = res.wb.toFixed(1);
            if(trigger !== 'rh') document.getElementById('prop-rh').value = res.rh.toFixed(0);
            
            // Sync Sliders
            document.getElementById('range-prop-db').value = res.db;
            document.getElementById('range-prop-rh').value = res.rh;
            document.getElementById('label-range-db').textContent = res.db.toFixed(1) + "¬∞C";
            document.getElementById('label-range-rh').textContent = res.rh.toFixed(0) + "%";

            updatePropCalcs(res.db, res.rh);
        }

        function handlePropSlider(trigger) {
            let db = document.getElementById('range-prop-db').value;
            let rh = document.getElementById('range-prop-rh').value;
            
            // Sliders only drive DB and RH. WB is result.
            // If trigger is DB slider -> Update WB input
            // If trigger is RH slider -> Update WB input
            
            const res = resolveState(db, 0, rh, 'rh'); // Force Calc WB
            
            document.getElementById('prop-db').value = parseFloat(db).toFixed(1);
            document.getElementById('prop-rh').value = parseFloat(rh).toFixed(0);
            document.getElementById('prop-wb').value = res.wb.toFixed(1);
            
            document.getElementById('label-range-db').textContent = parseFloat(db).toFixed(1) + "¬∞C";
            document.getElementById('label-range-rh').textContent = parseFloat(rh).toFixed(0) + "%";

            updatePropCalcs(parseFloat(db), parseFloat(rh));
        }

        function updatePropCalcs(db, rh) {
            const w = getW(db, rh);
            const h = getEnthalpy(db, w);
            const v = getVol(db, w);
            const dp = getDewPoint(db, rh);

            document.getElementById('calc-w').textContent = w.toFixed(1);
            document.getElementById('calc-h').textContent = h.toFixed(1);
            document.getElementById('calc-v').textContent = v.toFixed(3);
            document.getElementById('calc-dp').textContent = dp.toFixed(1);

            if(currentTab === 'properties' && chartInstance) {
                chartInstance.data.datasets[2].data = [{x: db, y: w}];
                chartInstance.data.datasets[3].data = [];
                chartInstance.update();
            }
        }

        // --- PROCESS TAB ---
        function handleProcessInput(prefix, trigger) {
            let db = document.getElementById(`${prefix}-db`).value;
            let wb = document.getElementById(`${prefix}-wb`).value;
            let rh = document.getElementById(`${prefix}-rh`).value;

            const res = resolveState(db, wb, rh, trigger);

            // Update DOM to reflect calcs
            if(trigger !== 'db') document.getElementById(`${prefix}-db`).value = res.db.toFixed(1);
            if(trigger !== 'wb') document.getElementById(`${prefix}-wb`).value = res.wb.toFixed(1);
            if(trigger !== 'rh') document.getElementById(`${prefix}-rh`).value = res.rh.toFixed(0);

            calcProcess();
        }

        function calcProcess() {
            // Get clean values
            const p1db = parseFloat(document.getElementById('p1-db').value);
            const p1rh = parseFloat(document.getElementById('p1-rh').value);
            const p2db = parseFloat(document.getElementById('p2-db').value);
            const p2rh = parseFloat(document.getElementById('p2-rh').value);
            const flow = parseFloat(document.getElementById('process-flow').value);

            const w1 = getW(p1db, p1rh);
            const h1 = getEnthalpy(p1db, w1);
            const w2 = getW(p2db, p2rh);
            const h2 = getEnthalpy(p2db, w2);

            const rho = 1.204;
            const m_dot = (flow / 1000) * rho;
            const qt = m_dot * Math.abs(h1 - h2);
            const qs = m_dot * 1.006 * Math.abs(p1db - p2db);
            const ql = qt - qs;
            const shr = qt > 0.01 ? qs/qt : 0;

            document.getElementById('res-qt').textContent = qt.toFixed(2) + " kW";
            document.getElementById('res-qs').textContent = qs.toFixed(2) + " kW";
            document.getElementById('res-ql').textContent = ql.toFixed(2) + " kW";
            document.getElementById('res-shr').textContent = shr.toFixed(2);

            if(currentTab === 'processes' && chartInstance) {
                chartInstance.data.datasets[2].data = [{x: p1db, y: w1}];
                chartInstance.data.datasets[3].data = [{x:p1db, y:w1}, {x:p2db, y:w2}];
                chartInstance.update();
            }
        }

        // --- MIXING TAB ---
        function handleMixingInput(prefix, trigger) {
            let db = document.getElementById(`${prefix}-db`).value;
            let wb = document.getElementById(`${prefix}-wb`).value;
            let rh = document.getElementById(`${prefix}-rh`).value;

            const res = resolveState(db, wb, rh, trigger);

            if(trigger !== 'db') document.getElementById(`${prefix}-db`).value = res.db.toFixed(1);
            if(trigger !== 'wb') document.getElementById(`${prefix}-wb`).value = res.wb.toFixed(1);
            if(trigger !== 'rh') document.getElementById(`${prefix}-rh`).value = res.rh.toFixed(0);

            calcMixing();
        }

        function calcMixing() {
            const m1f = parseFloat(document.getElementById('m1-flow').value);
            const m1db = parseFloat(document.getElementById('m1-db').value);
            const m1rh = parseFloat(document.getElementById('m1-rh').value);
            
            const m2f = parseFloat(document.getElementById('m2-flow').value);
            const m2db = parseFloat(document.getElementById('m2-db').value);
            const m2rh = parseFloat(document.getElementById('m2-rh').value);

            const total = m1f + m2f;
            if(total <= 0) return;

            const w1 = getW(m1db, m1rh);
            const h1 = getEnthalpy(m1db, w1);
            const w2 = getW(m2db, m2rh);
            const h2 = getEnthalpy(m2db, w2);

            const mixDb = (m1f*m1db + m2f*m2db)/total;
            const mixH = (m1f*h1 + m2f*h2)/total;
            const mixW = (m1f*w1 + m2f*w2)/total;
            
            // Reverse calc WB for display
            // Find WB where H(wb, sat) approx mixH or use simple iteration
            // Let's use robust state resolution. We know DB and W.
            // Find RH from DB and W
            const Ps = getPsat(mixDb);
            const Pv = (mixW/1000 * P_ATM) / (0.622 + mixW/1000);
            const mixRh = (Pv/Ps)*100;
            const mixWb = calcWB(mixDb, mixRh);

            document.getElementById('mix-db').textContent = mixDb.toFixed(1);
            document.getElementById('mix-wb').textContent = mixWb.toFixed(1);
            document.getElementById('mix-h').textContent = mixH.toFixed(1);

            if(currentTab === 'mixing' && chartInstance) {
                chartInstance.data.datasets[2].data = [{x: mixDb, y: mixW}];
                chartInstance.data.datasets[3].data = [{x:m1db, y:w1}, {x:m2db, y:w2}];
                chartInstance.update();
            }
        }

        function switchTab(id) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('[id^="nav-"]').forEach(el => el.className = "inactive-tab px-4 py-2 text-sm rounded-md transition-all");
            document.getElementById(`nav-${id}`).className = "active-tab px-4 py-2 text-sm rounded-md transition-all";

            document.querySelectorAll('[id^="mob-nav-"]').forEach(el => el.classList.replace('text-orange-600', 'text-stone-400'));
            document.getElementById(`mob-nav-${id}`).classList.replace('text-stone-400', 'text-orange-600');

            currentTab = id;
            if(id === 'properties') updatePropCalcs(parseFloat(document.getElementById('prop-db').value), parseFloat(document.getElementById('prop-rh').value));
            if(id === 'processes') calcProcess();
            if(id === 'mixing') calcMixing();
        }

        window.onload = function() {
            initChart();
            handlePropInput('db'); // Init calcs
        }
    </script>
</body>
</html>
```[Image of Psychrometric Chart]
[Image of HVAC Process]

